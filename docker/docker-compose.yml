# Complete SV2 Solo Mining Stack with Custom Templates
# Simplified Architecture (Single Bitcoin Core):
#   Bitcoin Core + sv2-tp (your custom template provider)
#     ↓ (custom templates)        ↓ (RPC for mempool)
#   Job Declarator Client         Job Declarator Server
#     ↓ (declares custom jobs)    ↓ (validates)
#   SV2 Pool ←─────────────────────┘
#     ↑ (fallback: hosted TP provides vanilla blocks)
#     ↓
#   Translation Proxy (SV1 ↔ SV2)
#     ↓
#   Your BitAxe / SV1 Miners

services:
  # Bitcoin Core + sv2-tp (your custom template provider)
  sv2-node:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: sv2-node
    ports:
      - "48332:48332"  # testnet4 RPC
      - "48333:48333"  # testnet4 P2P
      - "8442:8442"    # sv2-tp Template Provider
    volumes:
      - bitcoin-data:/root/.bitcoin
    networks:
      sv2_network:
        ipv4_address: 172.30.0.10
    restart: unless-stopped

  # Job Declarator Client - connects to sv2-tp and declares custom jobs
  jd-client:
    image: stratumv2/jd_client_sv2:v0.1.0
    container_name: jd-client
    command: ["/app/jd_client_sv2", "-c", "/app/jdc-config.toml"]
    volumes:
      - ./config/jdc-config.toml:/app/jdc-config.toml:ro
    networks:
      sv2_network:
        ipv4_address: 172.30.0.12
    depends_on:
      - sv2-node
      - jd-server
    restart: unless-stopped

  # Job Declarator Server - validates custom jobs against Bitcoin Core mempool
  jd-server:
    image: stratumv2/jd_server:v0.1.0
    container_name: jd-server
    command: ["/app/jd_server", "-c", "/app/jds-config.toml"]
    ports:
      - "34264:34264"  # JDS port
    volumes:
      - ./config/jds-config.toml:/app/jds-config.toml:ro
    networks:
      sv2_network:
        ipv4_address: 172.30.0.11
    depends_on:
      - sv2-node
    restart: unless-stopped

  # SV2 Pool - uses hosted TP for fallback, receives custom jobs from JDC
  pool:
    image: stratumv2/pool_sv2:v0.1.0
    container_name: sv2-pool
    command: ["/app/pool_sv2", "-c", "/app/pool-config.toml"]
    ports:
      - "34254:34254"  # Pool SV2 port
    volumes:
      - ./config/pool-config.toml:/app/pool-config.toml:ro
    networks:
      sv2_network:
        ipv4_address: 172.30.0.13
    depends_on:
      - jd-server
    restart: unless-stopped


  # Translation Proxy - allows SV1 miners (BitAxe) to connect to SV2 pool
  translator-proxy:
    image: stratumv2/translator_sv2:v0.1.0
    container_name: translator-proxy
    command: ["/app/translator_sv2", "-c", "/app/proxy-config.toml"]
    ports:
      - "34255:34255"  # SV1 miners connect here (stratum+tcp://localhost:34255)
    volumes:
      - ./config/translator-config.toml:/app/proxy-config.toml:ro
    networks:
      sv2_network:
        ipv4_address: 172.30.0.14
    depends_on:
      - pool
    restart: unless-stopped

  # CPU Miner (optional) - for testing without hardware
  # Uncomment to enable CPU mining directly to Pool
  cpu-miner:
    build:
      context: .
      dockerfile: Dockerfile.mining-device
    container_name: cpu-miner
    command: [
      "/app/mining_device",
      "--address-pool", "172.30.0.13:34254",
      "--pubkey-pool", "9auqWEzQDVyd2oe1JVGFLMLHZtCo2FFqZwtKA5gd9xbuEu7PH72",
      "--id-device", "docker-cpu-miner",
      "--handicap", "5000",  # 5ms delay to avoid overheating
      "--cores", "1"         # Use only 1 core
    ]
    networks:
      sv2_network:
        ipv4_address: 172.30.0.15
    depends_on:
      - pool
    restart: unless-stopped

volumes:
  bitcoin-data:

networks:
  sv2_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.30.0.0/16
